<div class="max-w-4xl mx-auto p-4">
  <div class="bg-white rounded-lg shadow-md p-8 max-w-4xl mx-auto mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">
      Fase 1: Presentaci√≥n de Propuestas
    </h2>
    <!-- <p class="text-gray-600">
      Aqu√≠ puedes crear el proyecto. consular su informacion y realizar correcciones.
    </p> -->
  </div>
  <!-- LISTADO DE PROYECTOS DEL PROFESOR EN FASE "PRESENTACI√ìN" -->

  <!-- Bloque para mostrar los archivos de la fase "Presentaci√≥n de Propuestas" -->
  <div *ngIf="archivosFase && archivosFase.length > 0" class="mb-4">
    <h2 class="text-xl font-bold">Archivos de Presentaci√≥n de Propuestas</h2>
  </div>

  <div
    *ngIf="archivosFase && archivosFase.length > 0"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4"
  >
    <div
      *ngFor="let archivo of archivosFase"
      class="bg-white p-3 rounded-lg shadow-lg hover:shadow-xl transition flex flex-col justify-between"
    >
      <div class="flex justify-center mb-1">
        <div
          class="w-10 h-10 bg-gray-200 rounded-full flex justify-center items-center"
        >
          <ng-container
            *ngIf="
              archivo['mime_type'] && archivo['mime_type'].includes('pdf');
              else otherIcon
            "
          >
            <img
              src="https://cdn-icons-png.flaticon.com/512/179/179483.png"
              alt="PDF Icon"
              class="w-7 h-7"
            />
          </ng-container>
          <ng-template #otherIcon>
            <img
              src="https://png.pngtree.com/element_our/md/20180627/md_5b33460fe6357.png"
              alt="Document Icon"
              class="w-9 h-9"
            />
          </ng-template>
        </div>
      </div>
      <h3 class="font-semibold mb-2 text-center flex-1">
        {{ archivo.titulo }}
      </h3>
      <button
        (click)="descargarArchivoFase(archivo.id!)"
        class="bg-blue-500 text-white py-1 px-2 rounded-lg hover:bg-blue-600 transition w-full text-center"
      >
        Descargar
      </button>
    </div>
  </div>

  <div *ngIf="proyectos.length > 0" class="mb-4">
    <h2 class="text-xl font-bold">
      Mis Proyectos en Presentaci√≥n de Propuesta
    </h2>
    <table class="min-w-full mt-4 border">
      <thead class="bg-gray-200">
        <tr>
          <th class="px-4 py-2 border">Nombre el Proyecto</th>
          <!-- <th class="px-4 py-2 border">Estado actual del proyecto</th> -->
          <th class="px-4 py-2 border">Fase Actual</th>
          <th class="px-4 py-2 border">Estado de la fase</th>
          <th class="px-4 py-2 border">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of proyectos">
          <td class="px-4 py-2 border">{{ p.nombre }}</td>
          <!-- <td class="px-4 py-2 border">{{ p.estado }}</td> -->
          <td class="px-4 py-2 border">{{ p.fase }}</td>
          <td class="px-4 py-2 border">{{ p.estado_fase }}</td>
          <td class="px-4 py-2 border">
            <button
              class="bg-blue-500 text-white px-2 py-1 mr-3 mb-1 rounded"
              (click)="verDetalleProyecto(p)"
            >
              Ver Detalle
            </button>
            <button
              class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded"
              (click)="verObservaciones(p)"
            >
              Ver Observaciones
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Bloque para mostrar los archivos de la fase "Presentaci√≥n de Propuestas" q subio el docente -->
    <div *ngIf="misArchivosFase && misArchivosFase.length > 0" class="mb-4">
      <h2 class="text-xl font-bold">
        Archivos subidos para Presentaci√≥n de Propuesta
      </h2>
    </div>

    <div
      *ngIf="misArchivosFase && misArchivosFase.length > 0"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4"
    >
      <div
        *ngFor="let archivo of misArchivosFase"
        class="bg-white p-3 rounded-lg shadow-lg hover:shadow-xl transition flex flex-col justify-between"
      >
        <div class="flex justify-center mb-1">
          <div
            class="w-10 h-10 bg-gray-200 rounded-full flex justify-center items-center"
          >
            <ng-container
              *ngIf="
                archivo['mime_type'] && archivo['mime_type'].includes('pdf');
                else otherIcon
              "
            >
              <img
                src="https://cdn-icons-png.flaticon.com/512/179/179483.png"
                alt="PDF Icon"
                class="w-7 h-7"
              />
            </ng-container>
            <ng-template #otherIcon>
              <img
                src="https://png.pngtree.com/element_our/md/20180627/md_5b33460fe6357.png"
                alt="Document Icon"
                class="w-9 h-9"
              />
            </ng-template>
          </div>
        </div>
        <h3 class="font-semibold mb-2 text-center flex-1">
          {{ archivo.titulo }}
        </h3>
        <button
          (click)="descargarArchivoFase(archivo.id!)"
          class="bg-blue-500 text-white py-1 px-2 rounded-lg hover:bg-blue-600 transition w-full text-center"
        >
          Descargar
        </button>
      </div>
    </div>
  </div>
  <!-- *ngIf="estadoProyecto === 'enviado' || estadoProyecto === 'correcciones'" -->
    <div *ngIf="editMode || canCreateProject(); else noCreation">
  
    <h1 class="text-2xl font-bold mb-4">
      Formulario de Formato de presentaci√≥n
    </h1>

    <form
      [formGroup]="projectForm"
      (ngSubmit)="onSubmit()"
      class="space-y-6"
      enctype="multipart/form-data"
    >
      <!-- Nombre del Proyecto -->
      <div>
        <label for="nombre" class="block text-sm font-medium"
          >Nombre del Proyecto</label
        >
        <input
          id="nombre"
          type="text"
          formControlName="nombre"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        />
        <div
          *ngIf="
            projectForm.get('nombre')?.touched &&
            projectForm.get('nombre')?.invalid
          "
          class="text-red-500 text-sm"
        >
          El nombre del proyecto es obligatorio.
        </div>
      </div>

      <!-- Dominio -->
      <div>
        <label for="dominio" class="block text-sm font-medium">Dominio</label>
        <input
          id="dominio"
          type="text"
          formControlName="dominio"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        />
        <div
          *ngIf="
            projectForm.get('dominio')?.touched &&
            projectForm.get('dominio')?.invalid
          "
          class="text-red-500 text-sm"
        >
          El dominio es obligatorio.
        </div>
      </div>

      <!-- Fase -->
      <div>
        <label for="fasePresentacion" class="block text-sm font-medium"
          >Fase</label
        >
        <select
          id="fasePresentacion"
          formControlName="fasePresentacion"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        >
          <option value="Fase 1">Fase 1</option>
          <option value="Fase 2">Fase 2</option>
          <option value="Fase 3">Fase 3</option>
        </select>
        <div
          *ngIf="
            projectForm.get('fasePresentacion')?.touched &&
            projectForm.get('fasePresentacion')?.invalid
          "
          class="text-red-500 text-sm"
        >
          La fase es obligatoria.
        </div>
      </div>

      <!-- Datos del Docente Coordinador -->
      <fieldset class="border rounded-md p-4">
        <legend class="text-lg font-medium">Docente Coordinador</legend>

        <div formGroupName="docente_coordinador" class="space-y-4">
          <div>
            <label for="docenteNombre" class="block text-sm font-medium"
              >Nombre</label
            >
            <input
              id="docenteNombre"
              type="text"
              formControlName="nombre"
              class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
            />
          </div>

          <div>
            <label for="docenteApellido" class="block text-sm font-medium"
              >Apellido</label
            >
            <input
              id="docenteApellido"
              type="text"
              formControlName="apellido"
              class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
            />
          </div>

          <div>
            <label for="docenteCedula" class="block text-sm font-medium"
              >C√©dula</label
            >
            <input
              id="docenteCedula"
              type="text"
              formControlName="cedula"
              class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
            />
          </div>

          <div>
            <label for="docenteTelefono" class="block text-sm font-medium"
              >Tel√©fono</label
            >
            <input
              id="docenteTelefono"
              type="text"
              formControlName="telefono"
              class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
            />
          </div>

          <div>
            <label for="docenteCorreo" class="block text-sm font-medium"
              >Correo</label
            >
            <input
              id="docenteCorreo"
              type="email"
              formControlName="correo"
              class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
            />
          </div>
        </div>
      </fieldset>

      <!-- Instituci√≥n Beneficiaria -->
      <div>
        <label for="institucion_beneficiaria" class="block text-sm font-medium"
          >Instituci√≥n Beneficiaria</label
        >
        <input
          id="institucion_beneficiaria"
          type="text"
          formControlName="institucion_beneficiaria"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        />
      </div>

      <!-- Cant√≥n -->
      <div>
        <label for="canton" class="block text-sm font-medium">Cant√≥n</label>
        <input
          id="canton"
          type="text"
          formControlName="canton"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        />
      </div>

      <!-- Parroquia -->
      <div>
        <label for="parroquia" class="block text-sm font-medium"
          >Parroquia</label
        >
        <input
          id="parroquia"
          type="text"
          formControlName="parroquia"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        />
      </div>

      <!-- Oferta Acad√©mica -->
      <div>
        <label for="oferta_academica" class="block text-sm font-medium"
          >Oferta Acad√©mica</label
        >
        <select
          id="oferta_academica"
          formControlName="oferta_academica"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        >
          <option value="Pregrado">Pregrado</option>
          <option value="Posgrado">Postgrado</option>
        </select>
      </div>

      <!-- Selector de Facultad -->
      <div>
        <label for="facultad" class="block text-sm font-medium">Facultad</label>
        <select
          id="facultad"
          formControlName="facultad"
          class="mt-1 block w-full p-2 border rounded-md"
        >
          <option value="">Seleccione una facultad</option>
          <option *ngFor="let facultad of facultades" [value]="facultad.nombre">
            {{ facultad.nombre }}
          </option>
        </select>
      </div>

      <!-- Selector de Carrera -->
      <div class="mt-4">
        <label for="carrera" class="block text-sm font-medium">Carrera</label>
        <select
          id="carrera"
          formControlName="carrera"
          class="mt-1 block w-full p-2 border rounded-md"
        >
          <option value="">Seleccione una carrera</option>
          <option *ngFor="let carrera of carrerasDisponibles" [value]="carrera">
            {{ carrera }}
          </option>
        </select>
      </div>

      <!-- Modalidad -->
      <div>
        <label for="modalidad" class="block text-sm font-medium"
          >Modalidad</label
        >
        <select
          id="modalidad"
          formControlName="modalidad"
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        >
          <option value="Presencial">Presencial</option>
          <option value="H√≠brida">H√≠brida</option>
          <option value="Online">Online</option>
        </select>
      </div>

      <!-- Datos del Estudiante -->
      <fieldset class="border rounded-md p-4">
        <legend class="text-lg font-medium">Datos del Estudiante</legend>

        <div formArrayName="estudiantes" class="space-y-6">
          <div
            *ngFor="let estudiante of estudiantes.controls; let i = index"
            [formGroupName]="i"
            class="border rounded-md p-4"
          >
            <div class="space-y-4">
              <div>
                <label for="estudianteNombre" class="block text-sm font-medium"
                  >Nombre</label
                >
                <input
                  id="estudianteNombre"
                  type="text"
                  formControlName="nombre"
                  class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
                />
              </div>

              <div>
                <label
                  for="estudianteApellido"
                  class="block text-sm font-medium"
                  >Apellido</label
                >
                <input
                  id="estudianteApellido"
                  type="text"
                  formControlName="apellido"
                  class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
                />
              </div>

              <div>
                <label for="estudianteCedula" class="block text-sm font-medium"
                  >C√©dula</label
                >
                <input
                  id="estudianteCedula"
                  type="text"
                  formControlName="cedula"
                  class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
                />
              </div>

              <div>
                <label for="estudianteGenero" class="block text-sm font-medium"
                  >G√©nero</label
                >
                <select
                  id="estudianteGenero"
                  formControlName="genero"
                  class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
                >
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                </select>
              </div>

              <div>
                <label for="estudianteCorreo" class="block text-sm font-medium"
                  >Correo</label
                >
                <input
                  id="estudianteCorreo"
                  type="email"
                  formControlName="correo"
                  class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
                />
              </div>

              <button
                type="button"
                class="mt-2 bg-red-500 text-white py-1 px-4 rounded-md hover:bg-red-600"
                (click)="eliminarEstudiante(i)"
              >
                Eliminar Estudiante
              </button>
            </div>
          </div>
        </div>

        <button
          type="button"
          class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600"
          (click)="agregarEstudiante()"
        >
          Agregar Estudiante
        </button>
      </fieldset>

      <!-- Subir Documentos -->
      <div>
        <label for="documentos" class="block text-sm font-medium"
          >Subir Documentos</label
        >
        <input
          id="documentos"
          type="file"
          accept=".doc, .docx"
          (change)="onFileSelect($event)"
          multiple
          class="mt-1 block w-full p-2 border rounded-md focus:ring focus:ring-blue-300"
        />
      </div>

      <!-- Bot√≥n de Enviar -->

      <button
        *ngIf="!editMode"
        type="submit"
        [disabled]="projectForm.invalid"
        class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50"
      >
        Registrar Proyecto
      </button>
      <button
        *ngIf="editMode"
        type="submit"
        [disabled]="projectForm.invalid"
        class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 disabled:opacity-50"
      >
        Corregir Proyecto
      </button>

      <!-- Mensajes de Retroalimentaci√≥n -->
      <div
        *ngIf="enviadoCorrectamente !== null"
        [ngClass]="
          enviadoCorrectamente
            ? 'bg-green-500 text-white'
            : 'bg-red-500 text-white'
        "
        class="fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-md shadow-lg flex items-center space-x-2 z-50"
      >
        <svg
          *ngIf="enviadoCorrectamente"
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2l4-4m1 5a7 7 0 110-14 7 7 0 010 14z"
          />
        </svg>
        <svg
          *ngIf="!enviadoCorrectamente"
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
        <span>
          {{
            enviadoCorrectamente
              ? "El formulario se envi√≥ correctamente."
              : "Ocurri√≥ un error al enviar el formulario. Int√©ntalo de nuevo."
          }}
        </span>
      </div>
    </form>
  </div>

  <!-- Template para el caso en que no se permite la creaci√≥n de un nuevo proyecto -->
  <ng-template #noCreation>
    <div class="p-4 bg-yellow-100 text-yellow-700 rounded-md shadow-md">
      <p>
        Solo puedes tener un proyecto en ejecuci√≥n por convocatoria. Ya tienes
        un proyecto activo.
      </p>
    </div>
  </ng-template>
  <!-- üìå Mensaje cuando el proyecto ya ha sido enviado -->
  <!-- <div
    *ngIf="estadoProyecto === 'aprobado' || estadoProyecto === 'en_revision'"
    class="bg-green-100 text-green-700 p-4 rounded-md shadow-md"
  >
    ‚úÖ Tu proyecto ha sido enviado y est√° en proceso de revisi√≥n. No puedes
    modificarlo en este momento.
  </div>

  <div
    *ngIf="estadoProyecto === 'correcciones'"
    class="bg-yellow-100 text-yellow-700 p-4 rounded-md shadow-md"
  >
    ‚ö†Ô∏è El administrador ha solicitado correcciones en tu proyecto. Puedes
    modificarlo y enviarlo de nuevo.
  </div> -->
  <!-- Modal para Observaciones -->
  <div
    *ngIf="modalObservacionesVisible"
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"
  >
    <div class="bg-white p-6 rounded-lg shadow-lg w-2/3 max-w-4xl">
      <h2 class="text-2xl font-bold mb-4">
        Observaciones de {{ proyectoConObservaciones?.nombre }}
      </h2>

      <!-- Tabla de observaciones -->
      <div class="overflow-x-auto">
        <table class="min-w-full border">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2 border">Comentario</th>
              <th class="px-4 py-2 border">Estado</th>
              <th class="px-4 py-2 border">Archivos</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let obs of observaciones">
              <td class="px-4 py-2 border">{{ obs.comentario }}</td>
              <td class="px-4 py-2 border">{{ obs.estado }}</td>
              <td class="px-4 py-2 border">
                <!-- Listar archivos de la observaci√≥n -->
                <div *ngIf="obs.archivos && obs.archivos.length > 0">
                  <div
                    *ngFor="let archivo of obs.archivos"
                    class="flex space-x-2 items-center mb-2"
                  >
                    <span class="text-sm text-gray-700">{{
                      archivo.titulo
                    }}</span>
                    <button
                      class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs"
                      (click)="descargarArchivo(archivo)"
                    >
                      Descargar
                    </button>
                  </div>
                </div>
                <div *ngIf="!obs.archivos || obs.archivos.length === 0">
                  <em class="text-gray-500">Sin archivos</em>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Bot√≥n para cerrar el modal -->
      <div class="flex justify-end mt-4">
        <button
          class="bg-gray-500 text-white px-4 py-2 rounded"
          (click)="cerrarModalObservaciones()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
